# Telegraf Configuration

[global_tags]
  environment = "production"
  project = "mssp-monitor"

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = "0s"
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# 輸出到 InfluxDB v2
[[outputs.influxdb_v2]]
  urls = ["${INFLUXDB_URL}"]
  token = "${INFLUXDB_TOKEN}"
  organization = "${INFLUXDB_ORG}"
  bucket = "${INFLUXDB_BUCKET}"
  timeout = "5s"

# 輸出到 Prometheus (透過 Remote Write)
[[outputs.prometheus_client]]
  listen = ":9273"
  metric_version = 2
  path = "/metrics"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# ── 已移除 Docker 監控（Windows 權限問題）──
# 如需啟用，請在 Linux 環境或調整 Docker Desktop 設定

# 收集系統 CPU 使用率
[[inputs.cpu]]
  percpu = true
  totalcpu = true
  collect_cpu_time = false
  report_active = false

# 收集記憶體使用率
[[inputs.mem]]

# 收集磁碟使用率
[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]

# 收集磁碟 I/O
[[inputs.diskio]]

# 收集網路流量
[[inputs.net]]
  interfaces = ["eth*"]

# 收集系統負載
[[inputs.system]]

# 監控 Prometheus Pushgateway (收集我們 Python 腳本推送的指標)
[[inputs.prometheus]]
  urls = ["http://prometheus-pushgateway:9091/metrics"]
  metric_version = 2

# 註：influxdb_v2_listener 已移除
# 原因：Python 腳本直接寫入 InfluxDB，不需要透過 Telegraf 接收

###############################################################################
#                       PROCESSOR PLUGINS                                     #
###############################################################################

# 為所有指標加上標籤
[[processors.rename]]
  [[processors.rename.replace]]
    tag = "host"
    dest = "hostname"

###############################################################################
#                       AGGREGATOR PLUGINS                                    #
###############################################################################

# 統計資料聚合
[[aggregators.basicstats]]
  period = "30s"
  drop_original = false
  stats = ["count", "min", "max", "mean", "stdev", "s2", "sum"]
